# نظام الموافقة على رسائل التواصل

## نظرة عامة
تم تطوير نظام موافقات متكامل لإدارة رسائل التواصل مع المواطنين في انتقالي العاصمة عدن.

## كيفية العمل

### 1. استقبال الرسالة
- عند وصول رسالة جديدة، تكون حالتها: **معلقة** (Pending)
- الحالة الأولية: `approval_status = 'pending'`

### 2. تحويل الرسالة (السكرتير/الإداري)
**الخطوات:**
1. الدخول إلى قائمة رسائل التواصل
2. فتح الرسالة المطلوبة
3. في قسم "ملاحظات الإدارة"، اختيار المسؤول من قائمة "تكليف إلى"
4. حفظ التحديثات

**النتيجة:**
- الحالة تتغير تلقائياً إلى: **محولة** (Forwarded)
- المسؤول المكلف يستقبل الرسالة في قائمة "رسائلي"

### 3. مراجعة الرسالة (المدير/المسؤول)
**الخطوات:**
1. الدخول إلى رسائل التواصل
2. تفعيل فلتر "رسائلي فقط" لعرض الرسائل المحولة له فقط
3. فتح الرسالة

**الخيارات المتاحة:**

#### أ) الموافقة على الرسالة
- إضافة ملاحظات الموافقة (اختياري)
- الضغط على زر "الموافقة على الرسالة"
- **النتيجة:**
  - `approval_status = 'approved'`
  - `status = 'in_progress'`
  - يتم حفظ الملاحظات وتاريخ الموافقة واسم الموافق

#### ب) رفض الرسالة
- إدخال سبب الرفض (إلزامي)
- الضغط على زر "رفض الرسالة"
- **النتيجة:**
  - `approval_status = 'rejected'`
  - `status = 'closed'`
  - يتم حفظ سبب الرفض وتاريخه واسم الرافض

## الصلاحيات

### 1. عرض رسائل التواصل (view_contact_messages)
- **من يملكها:** Admin, Super Admin, Editor, Author
- **الوصف:** عرض قائمة الرسائل وتفاصيلها

### 2. إدارة رسائل التواصل (manage_contact_messages)
- **من يملكها:** Admin, Super Admin
- **الوصف:** تحديث الحالة والملاحظات الإدارية

### 3. تكليف رسائل التواصل (assign_contact_messages)
- **من يملكها:** Admin, Super Admin
- **الوصف:** 
  - تحويل الرسائل للمسؤولين
  - الموافقة أو رفض الرسائل المحولة

### 4. حذف رسائل التواصل (delete_contact_messages)
- **من يملكها:** Admin, Super Admin
- **الوصف:** حذف الرسائل نهائياً

## الفلاتر المتاحة

### في صفحة القائمة:
1. **رسائلي فقط:** عرض الرسائل المكلفة للمستخدم الحالي
2. **حالة الموافقة:**
   - معلقة (Pending)
   - محولة (Forwarded)
   - موافق عليها (Approved)
   - مرفوضة (Rejected)
3. **الحالة العامة:** جديد، مقروء، قيد المعالجة، مغلق
4. **نوع اللقاء:** خاص، عام، عاجل

## عدادات الإحصائيات

- **جديد:** عدد الرسائل الجديدة
- **غير مقروء:** عدد الرسائل غير المقروءة
- **رسائلي:** عدد الرسائل المحولة للمستخدم الحالي (محولة فقط)

## حالات الموافقة (Approval Status)

| الحالة | الوصف | الإجراء التالي |
|--------|-------|----------------|
| **Pending** | رسالة جديدة لم يتم تحويلها | تحويل للمسؤول |
| **Forwarded** | محولة للمسؤول | موافقة أو رفض |
| **Approved** | موافق عليها | متابعة التنفيذ |
| **Rejected** | مرفوضة | إغلاق أو مراجعة |

## قاعدة البيانات

### الحقول الجديدة في جدول `contact_messages`:
```sql
- approval_status: enum('pending', 'forwarded', 'approved', 'rejected')
- approved_by: فوري كي للمستخدم الذي وافق/رفض
- approved_at: تاريخ ووقت الموافقة/الرفض
- rejection_reason: سبب الرفض
- approval_notes: ملاحظات الموافقة
```

## Routes الجديدة

```php
POST /admin/contact-messages/{id}/approve  // الموافقة
POST /admin/contact-messages/{id}/reject   // الرفض
```

## مثال عملي

### سيناريو كامل:

1. **السكرتير:**
   - يستقبل رسالة من مواطن يطلب لقاء
   - يفتح الرسالة ويراجع محتواها
   - يحولها لـ "مدير مكتب رئيس انتقالي عدن"
   - الحالة تصبح: **محولة**

2. **مدير المكتب:**
   - يدخل لوحة التحكم
   - يرى إشعار "رسائلي: 1"
   - يفتح الرسائل المحولة له
   - يقرأ الرسالة ويقرر:
     - **إذا وافق:** يكتب ملاحظات مثل "تم تحديد موعد اللقاء"
     - **إذا رفض:** يكتب سبب مثل "الموضوع خارج الاختصاص"

3. **بعد القرار:**
   - السكرتير والجميع يمكنهم رؤية القرار
   - تظهر ملاحظات الموافقة أو سبب الرفض
   - يتم حفظ سجل كامل بالإجراء

## ملاحظات مهمة

✅ **الموافقة/الرفض تظهر فقط:**
- للمستخدم المكلف بالرسالة
- إذا كانت الرسالة في حالة "محولة"
- إذا كان لديه صلاحية `assign_contact_messages`

✅ **التحويل التلقائي:**
- عند اختيار مسؤول في "تكليف إلى" لأول مرة
- الحالة تتغير من "معلقة" إلى "محولة" تلقائياً

✅ **الأمان:**
- جميع الإجراءات محمية بصلاحيات
- التحقق من الصلاحيات في Controller والـ Views

---

**تاريخ التطوير:** 11 نوفمبر 2025
**المطور:** Cascade AI Assistant
